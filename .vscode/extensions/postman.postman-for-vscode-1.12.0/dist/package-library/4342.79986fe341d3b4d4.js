"use strict";(self.webpackChunkpackage_library=self.webpackChunkpackage_library||[]).push([[4342],{8283:(e,a,t)=>{function i(e,a){if(null==e)return{};var t,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)t=r[i],a.indexOf(t)>=0||(n[t]=e[t]);return n}t.d(a,{Z:()=>i})},2836:(e,a,t)=>{function i(){return"package-service"}t.r(a),t.d(a,{ALLOWED_PROPS_FOR_TEXT:()=>Z,PackageService:()=>i,getScriptQuery:()=>E,isValidConfig:()=>Q,useCreatePackage:()=>T,useDeletePackage:()=>P,useIsPackageEnabled:()=>ae,usePackage:()=>d,usePackages:()=>m,usePackagesWithGlobalName:()=>b,usePlanFeatures:()=>j,usePlanUsageData:()=>X,useResourceUsage:()=>C,useScript:()=>S,useTemplateMessages:()=>J,useUpdatePackage:()=>w,useUpdateScript:()=>U});var n=t(7201),r=t(5860),s=t(6663),l=t.n(s);const o="package-library-service",c="packages",u="package",d=({packageId:e})=>(0,n.useDataFetch)((e=>({queryKey:[u,e],queryFn:({signal:a})=>(async({packageId:e,signal:a})=>(await r.postmanGateway.get({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:`/packages/${e}`,signal:a})).data)({packageId:e,signal:a}),enabled:!!e,useErrorBoundary:!1}))(e));var p=t(7560);const g=({cursor:e,isDeleted:a})=>({queryKey:[c],queryFn:({signal:t})=>(async({cursor:e,isDeleted:a=!1,signal:t})=>(await r.postmanGateway.get({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:"/packages",query:(0,p.Z)({},e&&{cursor:e},{isDeleted:a.toString()}),signal:t})).data)({signal:t,cursor:e,isDeleted:a}),useErrorBoundary:!1}),m=({cursor:e,isDeleted:a})=>(0,n.useDataFetch)(g({cursor:e,isDeleted:a}));var y=t(8283),v=t(540),h=t(6669);const k=["data"],b=()=>{const{data:e,isLoading:a}=(0,h.useTeamsByUserId)(),t=m({isDeleted:!1}),{data:i}=t,n=(0,y.Z)(t,k),r=a=>{var t;const i=null==e||null==(t=e.organizations[0])?void 0:t.domain;return i?["@"+i,a].join("/"):a},s=(0,v.useMemo)((()=>(null==i?void 0:i.map((e=>(0,p.Z)({},e,{globalName:r(e.name)}))))||[]),[a,n.isLoading]),l=(0,v.useMemo)((()=>{const e=new Map;if(null!=s&&s.length)for(const a of s)e.set(a.globalName,a.id);return e}),[s]);return(0,p.Z)({data:s,globalNameToIdMap:l},n)};var f=t(8749);const I="reusable_packages",L="/messages/packages/defaults/limits.json",_={thresholds:{notifyLimit:null,hardLimit:null,softLimit:null},templatePath:L},T=()=>(0,n.useMutation)({mutationFn:({workspaceId:e,requestBody:a,signal:t})=>(async({workspaceId:e,requestBody:a,signal:t})=>await r.postmanGateway.post({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:"/packages",query:{workspace:e},data:{body:a},signal:t}))({workspaceId:e,requestBody:a,signal:t}),onSettled:(e,a)=>{const t=g({isDeleted:!1}).queryKey;(0,n.updateCache)({key:t,updater:a=>a&&null!=e&&e.data?[e.data,...a]:a}),(0,n.invalidateCache)(t),(0,n.invalidateCache)((0,f.getUsageForOperation)({operation:I}).queryKey)}}),w=()=>(0,n.useMutation)({mutationFn:({packageId:e,patches:a,signal:t})=>(async({packageId:e,patches:a,signal:t})=>await r.postmanGateway.patch({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:`/packages/${e}`,data:{body:a},signal:t}))({packageId:e,patches:a,signal:t}),onSettled:(e,a,t)=>{(0,n.invalidateCache)([c]),(0,n.invalidateCache)([u,t.packageId])}}),P=()=>{const e=(0,n.useCacheClient)();return(0,n.useMutation)({mutationFn:({packageId:e,signal:a})=>(async({packageId:e,signal:a})=>await r.postmanGateway.delete({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:`/packages/${e}`,signal:a}))({packageId:e,signal:a}),onSuccess:(e,a)=>{(0,n.updateCache)({key:g({isDeleted:!1}).queryKey,updater:e=>e?e.filter((e=>e.id!==a.packageId)):e})},onSettled:(a,t,i)=>{(0,n.invalidateCache)([c]),(0,n.invalidateCache)((0,f.getUsageForOperation)({operation:I}).queryKey),e.removeQueries([u,i.packageId])}})},E=(e,a)=>({queryKey:[u,e,"script",a],queryFn:({signal:t})=>(async({packageId:e,scriptId:a,signal:t})=>(await r.postmanGateway.get({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:`/packages/${e}/scripts/${a}?include=contents`,signal:t})).data)({packageId:e,scriptId:a,signal:t}),enabled:!!e&&!!a,useErrorBoundary:!1}),S=({packageId:e,scriptId:a})=>(0,n.useDataFetch)(E(e,a)),U=()=>(0,n.useMutation)({mutationFn:({packageId:e,scriptId:a,patches:t,signal:i})=>(async({packageId:e,scriptId:a,patches:t,signal:i})=>await r.postmanGateway.patch({service:o,url:`${l().HTTPS_GATEWAY_PRIVATE_URL}/ws/proxy`,path:`/packages/${e}/scripts/${a}`,data:{body:t},signal:i}))({packageId:e,scriptId:a,patches:t,signal:i}),onSuccess:(e,a)=>{const t=E(a.packageId,a.scriptId).queryKey;(0,n.updateCache)({key:t,updater:a=>a&&null!=e&&e.data?(0,p.Z)({},a,{contents:e.data.contents}):a}),(0,n.invalidateCache)(t)}});var A=t(3101);function R(e){const a={};for(const t in e)e.hasOwnProperty(t)&&(a[e[t]]=t);return a}const x=e=>{var a;return null!==(null==e||null==(a=e.thresholds)?void 0:a.softLimit)},M=(e,a)=>{var t,i;if(x(e))return null===(null==e||null==(t=e.thresholds)?void 0:t.hardLimit)?null==a?void 0:a.limit:null==e||null==(i=e.thresholds)?void 0:i.hardLimit},N=(e,a)=>{var t,i;return void 0!==(null==e||null==(t=e.thresholds)?void 0:t.softLimit)?null==e||null==(i=e.thresholds)?void 0:i.softLimit:null==a?void 0:a.limit},F=(e,a)=>(0,p.Z)({},"object"==typeof(null==e?void 0:e.thresholds)?e.thresholds:{},{softLimit:N(e,a)}),G=(e,a)=>{if(!x(e)||void 0===O(a))return;const t=R(F(e,a)),i=Object.keys(t).map(Number).sort();return Math.max(...i.filter((e=>e<=O(a))))},O=e=>{if(e)return e.usage+e.spillage},j=()=>{var e;const a=(0,A.getUserId)(),{data:t,isLoading:i,isError:n}=(0,f.useGetPlanFeatures)(a),r=(e=>{let a=null==e?void 0:e.packages_usage_limit.value;if("string"==typeof a)try{a=JSON.parse(a)}catch(e){console.error("Error parsing plan features",e)}return a})(null==t||null==(e=t.data)?void 0:e.features);return{planFeatures:n?_:r,isLoading:i,isError:n}},C=()=>{const{data:e,isLoading:a,isError:t}=(0,f.useGetOperationUsage)(I);return{resourceUsage:null==e?void 0:e.operation,isLoading:a,isError:t}},q={library:{indicator:{notifyLimit:{type:"banner",title:"{{currentUsage}}/{{softLimit}} packages created",value:[{type:"text",value:" To increase the number of packages you can create, "},{type:"link",variation:"link-default",to:"{{artemisUrl}}/purchase",value:"upgrade plan",analytics:{action:"upgrade",label:"manual_run_soft_limit",value:"{{planName}}"},target:"_blank"},{type:"text",value:". Learn more about "},{type:"link",variation:"link-default",to:"https://go.pstmn.io/package-library-limits",value:"package limits",analytics:{action:"learn_more",label:"packages_soft_limit"},target:"_blank",isExternal:!0}]},softLimit:{type:"banner",status:"warning",title:"{{currentUsage}}/{{softLimit}} packages created",value:[{type:"text",value:" To increase the number of packages you can create, "},{type:"link",variation:"link-default",to:"{{artemisUrl}}/purchase",value:"upgrade plan",analytics:{action:"upgrade",label:"manual_run_soft_limit",value:"{{planName}}"},target:"_blank"},{type:"text",value:". Learn more about "},{type:"link",variation:"link-default",to:"https://go.pstmn.io/package-library-limits",value:"package limits",analytics:{action:"learn_more",label:"packages_soft_limit"},target:"_blank",isExternal:!0}]},hardLimit:{type:"banner",status:"error",title:"{{currentUsage}}/{{softLimit}} packages created",value:[{type:"text",value:" To continue creating packages, "},{type:"link",variation:"link-default",to:"{{artemisUrl}}/purchase",value:"upgrade plan",analytics:{action:"upgrade",label:"manual_run_soft_limit",value:"{{planName}}"},target:"_blank"},{type:"text",value:". Learn more about "},{type:"link",variation:"link-default",to:"https://go.pstmn.io/package-library-limits",value:"package limits",analytics:{action:"learn_more",label:"packages_soft_limit"},target:"_blank",isExternal:!0}]}}},buttons:{createPackage:{tooltip:{hardLimit:"You have reached the limit of {{softLimit}} packages. To continue creating packages, upgrade your plan."}}}},$=/^[\w !$%&'()*,./:=?{|}~-]+$/,D=new Set(["content-color-primary","content-color-secondary","content-color-tertiary","content-color-brand","content-color-info","content-color-error","content-color-warning","content-color-success","content-color-constant","content-color-link"]),V=new Set(["para","lead","small","strong","code","kbd","link-default","link-primary","link-button","link-button-primary","link-button-outline","link-subtle","body-small","body-medium","body-large"]),B=new Set(["primary","secondary","tertiary","plain","monochrome-plain","muted-plain"]),Y=new Set(["h1","h2","h3","h4","h5","h6"]),W=new Set(["text","heading"]),H=new Set(["button","link"]),K=new Set(["blue","purple","yellow","green","pink","teal","orange"]),Z=["color","isExternal"];function Q(e){var a,t;if(!e||"object"!=typeof e)return!1;const i=e.hideIcon&&"boolean"!=typeof e.hideIcon,n=e.status&&!["success","info","warning","error"].includes(e.status),r=e.title&&"string"!=typeof e.title&&!$.test(e.title),s=e.value&&"string"==typeof e.value&&!$.test(e.value),l=e.color&&!D.has(e.color),o=e.variation&&!V.has(e.variation),c=e.isExternal&&"boolean"!=typeof e.isExternal,u=!(null!=e&&null!=(a=e.value)&&a.every((e=>W.has(e.type)))),d=!(null!=e&&null!=(t=e.actions)&&t.every((e=>H.has(e.type)))),p=(null==e?void 0:e.trigger)&&!Q(e.trigger),g=(null==e?void 0:e.actions)&&!z(null==e?void 0:e.actions),m=e.color&&!K.has(e.color),y=e.value&&"string"==typeof e.value&&!$.test(e.value);switch(null==e?void 0:e.type){case"banner":return!(i||n||r||s)&&z(null==e?void 0:e.value);case"text":return!(l||o||c)&&z(null==e?void 0:e.value);case"popover":return!(d||u||p||g)&&z(null==e?void 0:e.value);case"tag":return!m&&!y&&$.test(e.value);default:return!1}}function z(e){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e))return e.every((e=>z(e)));const a=e.color&&!D.has(e.color),t=e.variation&&!V.has(e.variation),i=e.variation&&!V.has(e.variation),n=e.target&&"_blank"!==e.target,r=e.action&&!$.test(e.action),s=e.label&&!$.test(e.label),l=e.to&&"string"!=typeof e.to,o=e.variation&&!V.has(e.variation),c=!e.action||"string"!=typeof e.action,u=e.variation&&!B.has(e.variation),d=e.variation&&!Y.has(e.variation),p="string"!=typeof e.value;switch(null==e?void 0:e.type){case"text":return!(a||t||i)&&(Array.isArray(e.value)?e.value.every((e=>z(e))):$.test(e.value));case"link":return!(n||r||s||l||o)&&$.test(e.value);case"button":return!c&&!u&&$.test(e.value)&&$.test(e.action);case"heading":return!d&&!p&&$.test(e.value);default:return!1}}const J=e=>{var a,t,i;const{data:n,isLoading:r,isError:s,isRefetching:l,refetch:o}=(0,f.useGetTemplateMessages)(e);if(null!=n&&null!=(a=n.library)&&a.indicator&&"object"==typeof n.library.indicator){const e=n.library.indicator;for(const a of Object.values(e))if(!Q(a))return{messageTemplates:q,isLoading:r,isError:s,isRefetching:l,refetch:o}}if(null!=n&&null!=(t=n.buttons)&&t.createPackage&&"object"==typeof(null==n||null==(i=n.buttons)?void 0:i.createPackage)){const e=n.buttons.createPackage;for(const a of Object.values(e))if(!Q(a))return{messageTemplates:q,isLoading:r,isError:s,isRefetching:l,refetch:o}}return{messageTemplates:s?q:n,isLoading:r,isError:s,isRefetching:l,refetch:o}},X=()=>{var e;const{planFeatures:a}=j(),{resourceUsage:t}=C(),{messageTemplates:i}=J((null==a?void 0:a.templatePath)||L),n=(0,v.useMemo)((()=>((e,a)=>{const t=G(e,a);if(!t)return;const i=R(F(e,a));return null==i?void 0:i[t]})(a,t)),[a,t]),r=null==i?void 0:i.library.indicator,s=null==r?void 0:r[n],o=(0,v.useMemo)((()=>((e,a)=>{const t=F(e,a),i=M(e,a),n=O(a),r=N(e,a),s=G(e,a),o=(0,p.Z)({currentUsage:n,usageLimit:i,softLimit:r,applicableMessageThreshold:G(e,a)},"object"==typeof t?t:{},{artemisUrl:l().ARTEMIS_URL,planName:"planname"});Number.isInteger(i)&&Number.isInteger(n)&&0!==i&&Object.assign(o,{remainingLimit:i-n,remainingLimitPercentage:Math.ceil(100-n/i*100),hardLimitPercentUsed:Math.ceil(n/i*100)});const c=i-r;return Number.isInteger(i)&&Number.isInteger(r)&&Object.assign(o,{additionalLimit:c}),Number.isInteger(n)&&Number.isInteger(r)&&0!==r&&Object.assign(o,{additionalLimitUsed:n-r,remainingSoftLimit:r-n,remainingSoftLimitPercentage:Math.ceil(100-n/r*100),softLimitPercentUsed:Math.ceil(n/r*100)}),Number.isInteger(n)&&Number.isInteger(r)&&0!==c&&Number.isInteger(c)&&Object.assign(o,{additionalLimitRemaining:i-n,additionalLimitPercentageUsed:Math.ceil(100*(n-r)/c)}),Number.isInteger(s)&&Number.isInteger(n)&&Object.assign(o,{notificationThresholdPercentReached:Math.ceil(n/s*100)}),o})(a,t)),[a,t]),c=((e,a)=>{var t;const i=M(e,a),n=O(a);return!(!x(e)||!i||void 0===n)&&null!==(null==e||null==(t=e.thresholds)?void 0:t.hardLimit)&&n>=i})(a,t);return{planLimitMessageConfig:s,configTemplateVariables:o,isHardLimitReached:c,createNewPackageButtonTooltip:c?null==i||null==(e=i.buttons)||null==(e=e.createPackage)||null==(e=e.tooltip)?void 0:e.hardLimit:""}};var ee=t(99);const ae=()=>{const{planFeatures:e,isLoading:a,isError:t}=j(),{data:i}=(0,ee.useActiveWorkspaceInfo)(),n=null==i?void 0:i.visibilityStatus;return{isEnabled:(0,v.useMemo)((()=>!(!n||a||t)&&!![ee.VISIBILITY_STATUS.personal,ee.VISIBILITY_STATUS.team,ee.VISIBILITY_STATUS.private,""].includes(n)&&(null==e?void 0:e.isEnabled)),[n,a,t,null==e?void 0:e.isEnabled])}}}}]);
//# sourceMappingURL=4342.79986fe341d3b4d4.js.map